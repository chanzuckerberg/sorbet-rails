# typed: strict
class SorbetRails::RoutesRbiFormatter
  extend T::Sig

  sig { void }
  def initialize
    @buffer = T.let([], T::Array[T.any(String, T::Array[String])])
  end

  sig { params(title: String).void }
  def section_title(title)
    @buffer << "\n# Section #{title}"
  end

  sig { params(routes: T::Array[T::Hash[Symbol, String]]).void }
  def section(routes)
    @buffer << draw_section(routes)
  end

  sig { params(routes: T.untyped).returns(NilClass) }
  def header(routes)
  end

  sig { params(routes: T.untyped, filter: T.untyped).void }
  def no_routes(routes=nil, filter=nil)
    @buffer <<
      <<~MESSAGE
        # You do not have any routes defined!
        # Please add some routes in config/routes.rb.
        # For more information about routes, see the Rails guide: https://guides.rubyonrails.org/routing.html.
      MESSAGE
  end

  sig { returns(String) }
  def result
    <<~MESSAGE
      # This is an autogenerated file for routes helper methods

      # typed: strong
      class ActionController::Base
        extend T::Sig

      #{@buffer.join("\n").indent(2)}
      end
    MESSAGE
  end

  private
  sig { params(routes: T::Array[T::Hash[Symbol, String]]).returns(T::Array[String]) }
  def draw_section(routes)
    routes.map do |r|
      if r[:name].present?
        <<~MESSAGE
          # Sigs for route #{r[:path]}
          sig { params(args: T.untyped, kwargs: T.untyped).returns(String) }
          def #{r[:name]}_path(*args, **kwargs); end
          sig { params(args: T.untyped, kwargs: T.untyped).returns(String) }
          def #{r[:name]}_url(*args, **kwargs); end
        MESSAGE
      else
        nil
      end
    end.compact
  end
end
